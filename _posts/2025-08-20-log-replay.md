---
title: "Detection-as-Code for Wazuh 4.x: Log replay for behavioral testing"
tags:
  - Wazuh
  - SIEM
  - Detection
  - Detection Engineering
  - Testing
  - Detection-as-Code
galleryWslInstall:
  - url: /assets/replay-wsl-install.png
    image_path: /assets/replay-wsl-install.png
galleryGitLs:
  - url: /assets/replay-git-ls.png
    image_path: /assets/replay-git-ls.png
galleryVscode:
  - url: /assets/replay-vscode.png
    image_path: /assets/replay-vscode.png
galleryVscodePrompt:
- url: /assets/replay-vscode-prompt.png
    image_path: /assets/replay-vscode-prompt.png
galleryExplorer:
- url: /assets/replay-explorer.png
    image_path: /assets/replay-explorer.png
galleryTree:
- url: /assets/replay-4688.png
    image_path: /assets/replay-4688.png
galleryLogRepo:
- url: /assets/replay-log-repo.png
    image_path: /assets/replay-log-repo.png
galleryWazuhevtx:
- url: /assets/replay-wazuhevtx.png
    image_path: /assets/replay-wazuhevtx.png
galleryTscon:
- url: /assets/replay-tscon.png
    image_path: /assets/replay-tscon.png
galleryRed:
- url: /assets/replay-red.png
    image_path: /assets/replay-red.png
galleryGreen:
- url: /assets/replay-green.png
    image_path: /assets/replay-green.png
galleryRegression:
- url: /assets/replay-regression.png
    image_path: /assets/replay-regression.png
---

After my previous [blog article](./wazuh-devenv), I received feedback that it is good at providing a high-level perspective but lacks the bottom-up approach of technical implementations. Therefore, I decided to write a how-to guide dedicated to writing behavioral tests for Wazuh. In this article, we will walk through the steps one by one to install and set up the development environment on WSL and then write our first tests. I will try to do a walkthrough, but I'll add context whenever I can.

## Setting up the environment

### Installation

I am assuming you have your favorite IDE installed for Python-based development. I will use VS Code during this experiment as it is easier to initiate VS Code from WSL and run it in Windows easily.

1. Ensure you have WSL installed. If you don't have it, run the `wsl --install` command in an administrative session. When the WSL feature is installed, you need a reboot.
2. Install the distro you use in your production environment for proper replication of environments. At the time of writing, the supported WSL distros were listed like this:

```ini
wsl.exe --list --online
The following is a list of valid distributions that can be installed.
Install using 'wsl.exe --install <Distro>'.

NAME                            FRIENDLY NAME
AlmaLinux-8                     AlmaLinux OS 8
AlmaLinux-9                     AlmaLinux OS 9
AlmaLinux-Kitten-10             AlmaLinux OS Kitten 10
AlmaLinux-10                    AlmaLinux OS 10
Debian                          Debian GNU/Linux
FedoraLinux-42                  Fedora Linux 42
SUSE-Linux-Enterprise-15-SP6    SUSE Linux Enterprise 15 SP6
SUSE-Linux-Enterprise-15-SP7    SUSE Linux Enterprise 15 SP7
Ubuntu                          Ubuntu
Ubuntu-24.04                    Ubuntu 24.04 LTS
archlinux                       Arch Linux
kali-linux                      Kali Linux Rolling
openSUSE-Tumbleweed             openSUSE Tumbleweed
openSUSE-Leap-15.6              openSUSE Leap 15.6
Ubuntu-18.04                    Ubuntu 18.04 LTS
Ubuntu-20.04                    Ubuntu 20.04 LTS
Ubuntu-22.04                    Ubuntu 22.04 LTS
OracleLinux_7_9                 Oracle Linux 7.9
OracleLinux_8_10                Oracle Linux 8.10
OracleLinux_9_5                 Oracle Linux 9.5
```

3. I will proceed with Ubuntu LTS for the sake of this experiment. Run `wsl --install -d Ubuntu-22.04` to install Ubuntu WSL.

{% include gallery id="galleryWslInstall" caption="WSL first install screen" %}

4. Let's proceed with optimizing the configuration to limit the memory usage. Otherwise, Wazuh will eat up your memory. Open the file `~/.wslconfig` or create it if it does not exist, and add these lines:

```ini
# Settings apply across all Linux distros running on WSL 2
[wsl2]

# Limits VM memory to use no more than 4 GB, this can be set as whole numbers using GB or MB
memory=8GB 

# Sets the VM to use two virtual processors
processors=2
```

5. Update the memory and processor usage restrictions in accordance with your environment.
6. Open your WSL instance in the terminal or just type `wsl` in your existing PowerShell/cmd environment.
7. Proceed with setting the username and password for the first use. Then update all the packages using the default package manager of your distro. I'll use `sudo apt update; sudo apt upgrade -y; sudo apt autoremove` since this is a greenfield environment.
8. Let's clone the repo for first usage. Clone the repo in a preferred location in your WSL environment. I want to save the code directly under the current user's home directory. Let's see what will happen.

```bash
cd ~/
git clone https://github.com/zbalkan/wazuh-devenv.git
cd wazuh-devenv
ls
```

{% include gallery id="galleryGitLs" caption="Inside the repository" %}

9. Now, we can run `code .` command to open the directory in VS Code. You'll see the repository there, and at this point, we can just make use of VS Code for future updates.

{% include gallery id="galleryVscode" caption="VS Code first view" %}

10. Let's proceed with `sudo ./install.sh` so that we can initiate the Wazuh development environment installer. It is a script that tries to cover different distros and package managers, and when it comes to the configuration updates, it targets idempotency.
11. At one step, you will be asked to copy your current custom rules to the repository for further operations. Internally, we get rid of the default locations of `/var/ossec/etc/rules` and `/var/ossec/etc/decoders`, and mount the paths in the `wazuh-devenv` repository instead. Therefore, you will not have an issue with synchronizing different versions of rules and decoders. But this has a side effect. You may have to fix some permissions manually. I'll talk about that later. After you copied your rules and decoders, hit `y` and continue.

{% include gallery id="galleryVscodePrompt" caption="User is asked to copy custom rules and decoders, if any." %}

12. Then, you'll be prompted once again: `Enter the username to add to the wazuh group:`. This one must be your current user, not `root`. You will use your WSL default user for the future. Under the hood, the script adds this user to the `wazuh` group as a member, so that you can work with files easily.
13. For a smooth testing experience, create a folder at the root named `.vscode`, and copy the `sample.launch.json` under it. Rename the file to `launch.json`.
14. Use `venv` or any other module for creating your Python virtual environment. Even though we do not use any external dependencies, isolating the environment is safer.
15. The installation completes, and now you can work with detections as code with our new development environment.

## Writing your first tests

Full disclosure: I developed wazuh-devenv, wazuhevtx, and wazuh-testgen because I kept running into the same testing challenges in my own work. They’re open-source, built for my workflow, and may not be the only way to achieve these results. Feel free to adapt the concepts here using your own tools or methods—what matters is making detection testing repeatable and reliable.

### Wazuh rules under the hood

Now, I do not plan to repeat myself with the previous example of the Fortinet rule. This time, I will use a more detailed approach. But first, I need to remind the reader of the architectural aspects of Wazuh detections.

Wazuh rules are like building blocks. Unlike other rule languages like Sigma or query languages like SPL or KQL, Wazuh rules are built on top of each other in a tree structure. Wazuh, at the core, is a stream processing engine, and the most important component is the `wazuh-analysisd` service. This service loads Wazuh rules and builds several tree-like structures of rules based on `<if_sid>`, `<if_group>`, `<if_matched_sid>`, or `<if_matched_group>`. If a rule does not have a parent, it will be used first. But if you add a **virtual root** as the ultimate parent, you would see a directed acyclic graph (DAG)[^1]. Hypothetically, you can consider this virtual root as the starting point to match the rules. So, this virtual root rule means `any log`. The `wazuh-analysisd` service then starts checking against first-level children -aka rules with no parent- to find at least a partial match. Then, after finding the first matching node, the log is evaluated against the child rules of that, and so on. Therefore, the logic can be summed up as `the most specific rule wins`. This matching algorithm prevents iterating over all the rules. In the [Big O notation](https://en.wikipedia.org/wiki/Big_O_notation), this means `O(log N)` instead of `O(n)`, a huge performance impact.

This unique design also has side effects: converting Sigma or some other detection language to Wazuh is not a one-to-one translation job. You must find a parent for a proper detection logic. While you can have rules without a parent, you would end up with independent nodes and basically break the tree/graph structure I mentioned above. In the long term, you'll face performance issues. However, while drafting your rule, that is still the first step. You start with a very specific rule, then find a suitable parent in the current ruleset. We will use this approach very soon.

{% include gallery id="galleryExplorer" caption="Wazuh default ruleset visualized as a directed acyclic graph (DAG)" %}

In the graph above[^2], you can see the first-level rules, depicted as the children of the **virtual root** I created. It shows the rules with no parent rule. This is the starting point of every match. One of the great resources when detecting threats in Windows endpoints is the very noisy `Security Event ID 4688` [^3]. In the graph, you can see the parent-child relationship I have mentioned. In the reverse order, we can see these rules:

- 67027 - A process was created
- 60103 - Windows audit success event
- 60001 - Group of Windows rules for the security channel
- 60000 - Group of windows rules
- Our virtual root -meaning `any log`, something I created for a better comprehension.

{% include gallery id="galleryTree" caption="Wazuh rule `67027 - A process was created.` shown in the graph" %}

Now that we understand the way rules work, we can proceed with writing behavioral rules.

### What is behavioral testing?

The Wazuh rules are building blocks chained as tree or graph structures, as we mentioned in the previous paragraph. Therefore, testing single rules ensures that the engineer does not break the evaluation chain. This is the reason I called these tests [regression tests](https://en.wikipedia.org/wiki/Regression_testing): to ensure changes did not break previously functioning parts. But these do not guarantee better detection coverage. You need to use attack simulations for that. You can manually attack test devices or services and monitor the alerts. That way, we can ensure we are covering proper behavior-based detections in our environment.

But this is an expensive approach: one behavior at a time and writing detections afterwards requires a high amount of time and human resources. Luckily, there's a middle ground: replaying logs! We can make use of public resources for logs that contain malicious behavior, run them against our test harness, `wazuh-devenv`, and check if we can detect the malicious behavior effectively. And this is exactly what I'll do here.

Let's start with an amazing resource, [EVTX-to-MITRE-Attack](https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack) by [Michel de CREVOISIER](https://github.com/mdecrevoisier). The repository contains Windows event log samples mapped to MITRE ATT&CK TTPs that we can make use of.

{% include gallery id="galleryLogRepo" caption="EVTX-to-MITRE-Attack repository contains EVTX samples mapped to MITRE ATT&CK TTPs" %}

For educational purposes, I will check if we can detect Lateral Movement via Remote Desktop ([T1021.001](https://attack.mitre.org/techniques/T1021/001/)) using the default rules. But we cannot use the EVTX files in our test environment. The `wazuh-devenv` tests expect logs as plain strings. We need to convert EVTX files to text that Wazuh can use. In a previous article, [Enhancing Wazuh Rule Testing with wazuhevtx: A Solution for Windows Event Logs](https://zaferbalkan.com/wazuhevtx/), I mentioned a tool I developed called [wazuhevtx](https://github.com/zbalkan/wazuhevtx) that works on Windows to convert EVTX files to JSONL-formatted logs, the same way Wazuh agent converts. We can just run `pip install wazuhevtx` or `pipx install wazuhevtx` and copy the generated logs as our test data.

{% include gallery id="galleryWazuhevtx" caption="You can use pip or pipx to download wazuhevtx tool" %}

But now, we'll use a helper to speed up the process by using a test generator that I simply called [wazuh-testgen](https://github.com/zbalkan/wazuh-testgen). This is a separate tool I created to support the `wazuh-devenv` project. Thanks to the `wazuhevtx` library, we can just provide an attack scenario, the directory of EVTX files, and the output files, and get a template for writing behavioral tests to start working on. The `evtx` subcommand of the `wazuh-testgen` imports the `wazuhevtx` library to convert the logs in memory and processes to generate test templates. Below, you can see the usage for the EVTX subcommand.

```bash
usage: generator.py evtx [-h] --scenario SCENARIO --input_dir INPUT_DIR --output_dir OUTPUT_DIR

options:
  -h, --help            show this help message and exit
  --scenario, -s SCENARIO
                        Name for the tests to use for the generated tests.
  --input_dir, -i INPUT_DIR
                        Directory where input files are located.
  --output_dir, -o OUTPUT_DIR
                        Directory where the Python test files will be saved.
```

For the sake of convenience, I copied the EVTX files into a folder called `input` under the `wazuh-testgen` project, and set the target folder as `output` in the same directory. By running the command `python src/generator.py evtx --scenario T1021.001-Remote Desktop Protocol --input_dir input/T1021.001-Remote Desktop Protocol --output_dir output/behavioral_tests`, I came up with the test template code below:

```python
import unittest

import internal.logtest as lt  # type: ignore


class TestT1021001RemoteDesktopProtocol(unittest.TestCase):

    def test_id4688_4778_4779_rdp_hijack_direct(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3522301Z", "eventRecordID": "1829814", "processID": "4", "threadID": "5820", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x378\r\n\tNew Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x13e8\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\tcmd  /k tscon 2 /dest:rdp-tcp#8\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x378", "newProcessName": "C:\\Windows\\System32\\cmd.exe", "tokenElevationType": "%%1936", "processId": "0x13e8", "commandLine": "cmd  /k tscon 2 /dest:rdp-tcp#8", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3588944Z", "eventRecordID": "1829815", "processID": "4", "threadID": "5820", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x6e8\r\n\tNew Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x378\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\ttscon  2 /dest:rdp-tcp#8\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x6e8", "newProcessName": "C:\\Windows\\System32\\tscon.exe", "tokenElevationType": "%%1936", "processId": "0x378", "commandLine": "tscon  2 /dest:rdp-tcp#8", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4779", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3700303Z", "eventRecordID": "1829816", "processID": "576", "threadID": "628", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was disconnected from a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\n\r\nThis event is generated when a user disconnects from an existing Terminal Services session, or when a user switches away from an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmig", "accountDomain": "OFFSEC", "logonID": "0x13b5e1e", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.5727118Z", "eventRecordID": "1829817", "processID": "4", "threadID": "164", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x714\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x714", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.7445062Z", "eventRecordID": "1829818", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x17a8\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x17a8", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4778", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.8317487Z", "eventRecordID": "1829819", "processID": "576", "threadID": "4904", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was reconnected to a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\nThis event is generated when a user reconnects to an existing Terminal Services session, or when a user switches to an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmarsid", "accountDomain": "OFFSEC", "logonID": "0x6a423", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:06.2032818Z", "eventRecordID": "1829820", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xc14\r\n\tNew Process Name:\tC:\\Windows\\System32\\AtBroker.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xd5c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\winlogon.exe\r\n\tProcess Command Line:\tatbroker.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xc14", "newProcessName": "C:\\Windows\\System32\\AtBroker.exe", "tokenElevationType": "%%1938", "processId": "0xd5c", "commandLine": "atbroker.exe", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\winlogon.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:06.2061179Z", "eventRecordID": "1829821", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-20\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E4\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x438\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x33c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\trdpclip\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-20", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e4", "newProcessId": "0x438", "newProcessName": "C:\\Windows\\System32\\rdpclip.exe", "tokenElevationType": "%%1938", "processId": "0x33c", "commandLine": "rdpclip", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:07.0512821Z", "eventRecordID": "1829822", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x110c\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x110c", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:07.1508264Z", "eventRecordID": "1829823", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x460\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x460", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:37.1112946Z", "eventRecordID": "1829826", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1548\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1548", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:14.7898832Z", "eventRecordID": "1829827", "processID": "4", "threadID": "4288", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x5e8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x5e8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:35.0895205Z", "eventRecordID": "1829828", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16c4\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe U\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16c4", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe U", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:35.2084322Z", "eventRecordID": "1829829", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x5b8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x5b8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # If you want to check every log, simply use a for loop
        # for _, response in enumerate(responses):
        #     self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        #     self.assertEqual(response.decoder, 'json')

        #     Example: Set expected Wazuh rule ID and level when analyzing logs
        #     expected_rule_id = None  # Replace with actual rule ID
        #     expected_rule_level = None  # Replace with actual rule level

        #     self.assertEqual(response.rule_id, expected_rule_id)
        #       self.assertEqual(response.rule_level, expected_rule_level)

        # If you want a simple result after a series of logs, you can use an "at least one" control. For instance:

        # Ensure there is at least one alert gets triggered with T1021.001 - Remote Services: Remote Desktop Protocol
        expected_mitre_id: set[str] = {'T1021.001'}
        self.assertTrue(expr=any(expected_mitre_id & r.rule_mitre_ids for r in responses if r.rule_mitre_ids),
                        msg='T1021.001 not found in MITRE ATT&CK IDs')

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")

    def test_id4688_4778_rdp_hijack_command_execution(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8391154Z", "eventRecordID": "1829536", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B593D\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1490\r\n\tNew Process Name:\tC:\\Windows\\System32\\sc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeFull (2)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0xbc0\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\tsc.exe  start hijackservice\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x13b593d", "newProcessId": "0x1490", "newProcessName": "C:\\Windows\\System32\\sc.exe", "tokenElevationType": "%%1937", "processId": "0xbc0", "commandLine": "sc.exe  start hijackservice", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8467736Z", "eventRecordID": "1829537", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1278\r\n\tNew Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x230\r\n\tCreator Process Name:\tC:\\Windows\\System32\\services.exe\r\n\tProcess Command Line:\tcmd.exe /k tscon 2 /dest:rdp-tcp#5\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1278", "newProcessName": "C:\\Windows\\System32\\cmd.exe", "tokenElevationType": "%%1936", "processId": "0x230", "commandLine": "cmd.exe /k tscon 2 /dest:rdp-tcp#5", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\services.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8530375Z", "eventRecordID": "1829538", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x143c\r\n\tNew Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x1278\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\ttscon  2 /dest:rdp-tcp#5\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x143c", "newProcessName": "C:\\Windows\\System32\\tscon.exe", "tokenElevationType": "%%1936", "processId": "0x1278", "commandLine": "tscon  2 /dest:rdp-tcp#5", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8566410Z", "eventRecordID": "1829539", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x334\r\n\tNew Process Name:\tC:\\Windows\\System32\\conhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x143c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tProcess Command Line:\t\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x334", "newProcessName": "C:\\Windows\\System32\\conhost.exe", "tokenElevationType": "%%1936", "processId": "0x143c", "commandLine": "\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\tscon.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.1608977Z", "eventRecordID": "1829541", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x161c\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x161c", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.4013198Z", "eventRecordID": "1829542", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xbcc\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xbcc", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4778", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.5330674Z", "eventRecordID": "1829543", "processID": "576", "threadID": "628", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was reconnected to a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#5\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\nThis event is generated when a user reconnects to an existing Terminal Services session, or when a user switches to an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmarsid", "accountDomain": "OFFSEC", "logonID": "0x6a423", "sessionName": "RDP-Tcp#5", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.8655575Z", "eventRecordID": "1829544", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-20\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E4\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1064\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x33c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\trdpclip\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-20", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e4", "newProcessId": "0x1064", "newProcessName": "C:\\Windows\\System32\\rdpclip.exe", "tokenElevationType": "%%1938", "processId": "0x33c", "commandLine": "rdpclip", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.8803374Z", "eventRecordID": "1829545", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16a0\r\n\tNew Process Name:\tC:\\Windows\\System32\\AtBroker.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xd5c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\winlogon.exe\r\n\tProcess Command Line:\tatbroker.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16a0", "newProcessName": "C:\\Windows\\System32\\AtBroker.exe", "tokenElevationType": "%%1938", "processId": "0xd5c", "commandLine": "atbroker.exe", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\winlogon.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.9362477Z", "eventRecordID": "1829546", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x878\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpinput.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xeec\r\n\tCreator Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "subjectUserName": "admmarsid", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x6a423", "newProcessId": "0x878", "newProcessName": "C:\\Windows\\System32\\rdpinput.exe", "tokenElevationType": "%%1938", "processId": "0xeec", "commandLine": "\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\rdpclip.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.9993967Z", "eventRecordID": "1829547", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xda0\r\n\tNew Process Name:\tC:\\Windows\\System32\\consent.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tconsent.exe 1072 362 000001A5ECFB0F80\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xda0", "newProcessName": "C:\\Windows\\System32\\consent.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "consent.exe 1072 362 000001A5ECFB0F80", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.0786447Z", "eventRecordID": "1829550", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16b8\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16b8", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.1945404Z", "eventRecordID": "1829553", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x17a8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x17a8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.3276957Z", "eventRecordID": "1829554", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xeb4\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xeb4", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.3438895Z", "eventRecordID": "1829555", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x162c\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpinput.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0xeec\r\n\tCreator Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x162c", "newProcessName": "C:\\Windows\\System32\\rdpinput.exe", "tokenElevationType": "%%1938", "processId": "0xeec", "commandLine": "\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\rdpclip.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:26.9427316Z", "eventRecordID": "1829562", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1578\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{DC4537C3-CA73-4AC7-9E1D-B2CE27C3A7A6}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1578", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{DC4537C3-CA73-4AC7-9E1D-B2CE27C3A7A6}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.4552441Z", "eventRecordID": "1829563", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x864\r\n\tNew Process Name:\tC:\\Windows\\System32\\mmc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x9f4\r\n\tCreator Process Name:\tC:\\Windows\\explorer.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "subjectUserName": "admmarsid", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x6a423", "newProcessId": "0x864", "newProcessName": "C:\\Windows\\System32\\mmc.exe", "tokenElevationType": "%%1938", "processId": "0x9f4", "commandLine": "\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\explorer.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.5421558Z", "eventRecordID": "1829564", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1620\r\n\tNew Process Name:\tC:\\Windows\\System32\\consent.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tconsent.exe 1072 426 000001A5F05BA860\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1620", "newProcessName": "C:\\Windows\\System32\\consent.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "consent.exe 1072 426 000001A5F05BA860", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.6403302Z", "eventRecordID": "1829569", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x144c\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x144c", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.6766154Z", "eventRecordID": "1829572", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xe84\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xe84", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.7069657Z", "eventRecordID": "1829573", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A3F3\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xcc8\r\n\tNew Process Name:\tC:\\Windows\\System32\\mmc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeFull (2)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0x9f4\r\n\tCreator Process Name:\tC:\\Windows\\explorer.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xcc8", "newProcessName": "C:\\Windows\\System32\\mmc.exe", "tokenElevationType": "%%1937", "processId": "0x9f4", "commandLine": "\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a3f3", "parentProcessName": "C:\\Windows\\explorer.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:30.6000428Z", "eventRecordID": "1829593", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1628\r\n\tNew Process Name:\tC:\\Windows\\System32\\backgroundTaskHost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-4096\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\backgroundTaskHost.exe\" -ServerName:CortanaUI.AppXy7vb4pc2dr3kc93kfc509b1d0arkfb2x.mca\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1628", "newProcessName": "C:\\Windows\\System32\\backgroundTaskHost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "\"C:\\Windows\\system32\\backgroundTaskHost.exe\" -ServerName:CortanaUI.AppXy7vb4pc2dr3kc93kfc509b1d0arkfb2x.mca", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-4096"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # If you want to check every log, simply use a for loop
        # for _, response in enumerate(responses):
        #     self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        #     self.assertEqual(response.decoder, 'json')

        #     Example: Set expected Wazuh rule ID and level when analyzing logs
        #     expected_rule_id = None  # Replace with actual rule ID
        #     expected_rule_level = None  # Replace with actual rule level

        #     self.assertEqual(response.rule_id, expected_rule_id)
        #       self.assertEqual(response.rule_level, expected_rule_level)

        # If you want a simple result after a series of logs, you can use an "at least one" control. For instance:

        # Ensure there is at least one alert gets triggered with T1021.001 - Remote Services: Remote Desktop Protocol
        expected_mitre_id: set[str] = {'T1021.001'}
        self.assertTrue(expr=any(expected_mitre_id & r.rule_mitre_ids for r in responses if r.rule_mitre_ids),
                        msg='T1021.001 not found in MITRE ATT&CK IDs')

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")

    def test_id4825_denied_rdp_connection_with_valid_credentials(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4825", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8010000000000000", "systemTime": "2020-07-12T05:27:05.5797045Z", "eventRecordID": "1231498", "processID": "464", "threadID": "992", "channel": "Security", "computer": "fs02.offsec.lan", "severityValue": "AUDIT_FAILURE", "message": "A user was denied the access to Remote Desktop. By default, users are allowed to connect only if they are members of the Remote Desktop Users group or Administrators group.\r\n\r\nSubject:\r\n\tUser Name:\tsvc6test1\r\n\tDomain:\t\tOFFSEC\r\n\tLogon ID:\t0x3457272\r\n\r\nAdditional Information:\r\n\tClient Address:\t10.23.23.9\r\n\r\n\r\nThis event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop."}, "eventdata": {"accountName": "svc6test1", "accountDomain": "OFFSEC", "logonID": "0x3457272", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4825", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8010000000000000", "systemTime": "2020-07-12T05:28:26.8313792Z", "eventRecordID": "1231525", "processID": "464", "threadID": "284", "channel": "Security", "computer": "fs02.offsec.lan", "severityValue": "AUDIT_FAILURE", "message": "A user was denied the access to Remote Desktop. By default, users are allowed to connect only if they are members of the Remote Desktop Users group or Administrators group.\r\n\r\nSubject:\r\n\tUser Name:\tsvc6test1\r\n\tDomain:\t\tOFFSEC\r\n\tLogon ID:\t0x34696A9\r\n\r\nAdditional Information:\r\n\tClient Address:\t10.23.23.9\r\n\r\n\r\nThis event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop."}, "eventdata": {"accountName": "svc6test1", "accountDomain": "OFFSEC", "logonID": "0x34696a9", "clientAddress": "10.23.23.9"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # If you want to check every log, simply use a for loop
        # for _, response in enumerate(responses):
        #     self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        #     self.assertEqual(response.decoder, 'json')

        #     Example: Set expected Wazuh rule ID and level when analyzing logs
        #     expected_rule_id = None  # Replace with actual rule ID
        #     expected_rule_level = None  # Replace with actual rule level

        #     self.assertEqual(response.rule_id, expected_rule_id)
        #       self.assertEqual(response.rule_level, expected_rule_level)

        # If you want a simple result after a series of logs, you can use an "at least one" control. For instance:

        # Ensure there is at least one alert gets triggered with T1021.001 - Remote Services: Remote Desktop Protocol
        expected_mitre_id: set[str] = {'T1021.001'}
        self.assertTrue(expr=any(expected_mitre_id & r.rule_mitre_ids for r in responses if r.rule_mitre_ids),
                        msg='T1021.001 not found in MITRE ATT&CK IDs')

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
```

If you remember [the previous post](https://zaferbalkan.com/wazuh-devenv/#workflow-overview), I mentioned the **Red, Green, Refactor** approach there. We are in the **Red** phase now: the tests fail, because we wrote the tests first, not the code. Now, our task is to satisfy the tests and make it green. However, the generated test above is a template. We must define our requirements for how to do that.

Let's go step by step. On the first two files, namely `ID4688,4778,4779 RDP hijack direct.evtx` and `ID4688-4778 RDP hijack command execution.evtx`, we can see the usage of `tscon.exe`. There's a very old and obvious procedure that we can use in our detections.

{% include gallery id="galleryTscon" caption="The lolbin tscon.exe is used to hijack RDP session" %}

But first, we must fix our tests. Let's define our requirements. The first two event log samples show the usage of `tscon`.

1. Ensure that there is a response for each log. This is to ensure the test data is not corrupted and does not break the analysis.
2. Ensure that there is an alert with level **12** and has a MITRE ATT&CK TTP ID of *T1021.001 - Remote Services: Remote Desktop Protocol*.
3. Ensure that there is an alert with level **12** and has a MITRE ATT&CK TTP ID of *T1563.002 - Remote Service Session Hijacking: RDP Hijacking*.

The first file, `ID4688,4778,4779 RDP hijack direct.evtx` also has a session disconnect and a reconnect event. But the devil is in the details: the RDP session name is the same, but user accounts are different. Let's detect that.

1. Ensure that there is a response for each log. This is to ensure the test data is not corrupted and does not break the analysis.
2. Ensure that there is an alert with level **15** and has a MITRE ATT&CK TTP ID of *T1021.001 - Remote Services: Remote Desktop Protocol*.
3. Ensure that there is an alert with level **15** and has a MITRE ATT&CK TTP ID of *T1563.002 - Remote Service Session Hijacking: RDP Hijacking*.
3. Ensure that there is an alert with level **15** and has a MITRE ATT&CK TTP ID of *T1078 - Valid Accounts*.

The last file, `ID4825-Denied RDP connection with valid credentials.evtx`, is not an obvious [indicator of attack (IOA)](https://www.splunk.com/en_us/blog/learn/ioa-indicators-of-attack.html), but a medium-level helper that allows us to be informed by the denied authentication for RDP. The requirements are similar here.

1. Ensure that there is a response for each log. This is to ensure the test data is not corrupted and does not break the analysis.
2. Ensure that there is an alert with level **5** and has a MITRE ATT&CK TTP ID of *T1021.001 - Remote Services: Remote Desktop Protocol*.
3. Ensure that there is an alert with level **5** and has a MITRE ATT&CK TTP ID of *T1078 - Valid Accounts*.
4. Ensure that there is an alert with level **5** and has a group named *authentication_failed*.

The first difference is about the MITRE ATT&CK labels, as the first one is an obvious hijacking indicator, and needs an additional [T1563.002 - Remote Service Session Hijacking: RDP Hijacking](https://attack.mitre.org/techniques/T1563/002/) tag. The other difference is in the rule levels. According to the Wazuh [rules classification guide](https://documentation.wazuh.com/current/user-manual/ruleset/rules/rules-classification.html), level 12 means a "High importance event" and level 5 means "User generated error". Since the denial of RDP connection is a denied access, we added a group check as well. They look like accurate levels for these events.

So, let's write our first tests and run them!

```python
import unittest

import internal.logtest as lt


class TestT1021001RemoteDesktopProtocol(unittest.TestCase):

    def test_id4688_4778_4779_rdp_hijack_direct(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3522301Z", "eventRecordID": "1829814", "processID": "4", "threadID": "5820", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x378\r\n\tNew Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x13e8\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\tcmd  /k tscon 2 /dest:rdp-tcp#8\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x378", "newProcessName": "C:\\Windows\\System32\\cmd.exe", "tokenElevationType": "%%1936", "processId": "0x13e8", "commandLine": "cmd  /k tscon 2 /dest:rdp-tcp#8", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3588944Z", "eventRecordID": "1829815", "processID": "4", "threadID": "5820", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x6e8\r\n\tNew Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x378\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\ttscon  2 /dest:rdp-tcp#8\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x6e8", "newProcessName": "C:\\Windows\\System32\\tscon.exe", "tokenElevationType": "%%1936", "processId": "0x378", "commandLine": "tscon  2 /dest:rdp-tcp#8", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4779", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3700303Z", "eventRecordID": "1829816", "processID": "576", "threadID": "628", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was disconnected from a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\n\r\nThis event is generated when a user disconnects from an existing Terminal Services session, or when a user switches away from an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmig", "accountDomain": "OFFSEC", "logonID": "0x13b5e1e", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.5727118Z", "eventRecordID": "1829817", "processID": "4", "threadID": "164", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x714\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x714", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.7445062Z", "eventRecordID": "1829818", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x17a8\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x17a8", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4778", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.8317487Z", "eventRecordID": "1829819", "processID": "576", "threadID": "4904", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was reconnected to a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\nThis event is generated when a user reconnects to an existing Terminal Services session, or when a user switches to an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmarsid", "accountDomain": "OFFSEC", "logonID": "0x6a423", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:06.2032818Z", "eventRecordID": "1829820", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xc14\r\n\tNew Process Name:\tC:\\Windows\\System32\\AtBroker.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xd5c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\winlogon.exe\r\n\tProcess Command Line:\tatbroker.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xc14", "newProcessName": "C:\\Windows\\System32\\AtBroker.exe", "tokenElevationType": "%%1938", "processId": "0xd5c", "commandLine": "atbroker.exe", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\winlogon.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:06.2061179Z", "eventRecordID": "1829821", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-20\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E4\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x438\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x33c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\trdpclip\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-20", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e4", "newProcessId": "0x438", "newProcessName": "C:\\Windows\\System32\\rdpclip.exe", "tokenElevationType": "%%1938", "processId": "0x33c", "commandLine": "rdpclip", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:07.0512821Z", "eventRecordID": "1829822", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x110c\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x110c", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:07.1508264Z", "eventRecordID": "1829823", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x460\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x460", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:37.1112946Z", "eventRecordID": "1829826", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1548\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1548", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:14.7898832Z", "eventRecordID": "1829827", "processID": "4", "threadID": "4288", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x5e8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x5e8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:35.0895205Z", "eventRecordID": "1829828", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16c4\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe U\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16c4", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe U", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:02:35.2084322Z", "eventRecordID": "1829829", "processID": "4", "threadID": "4764", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x5b8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x5b8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # Ensure there is at least one level 12 alert gets triggered with MITRE labels
        # T1021.001 - Remote Services: Remote Desktop Protocol and T1563.002 - Remote Service Session Hijacking: RDP Hijacking
        expected_mitre_id: set[str] = {'T1021.001', 'T1563.002'}
        self.assertTrue(expr=any((expected_mitre_id <= r.rule_mitre_ids) and (int(r.rule_level) == 12)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 12 alert found with T1021.001 and T1563.002 MITRE ATT&CK IDs')

        # Ensure there is at least one level 15 alert gets triggered with MITRE labels
        # T1021.001 - Remote Services: Remote Desktop Protocol, T1563.002 - Remote Service Session Hijacking: RDP Hijacking
        # and T1078 - Valid Accounts
        expected_mitre_id: set[str] = {'T1021.001', 'T1563.002', 'T1078'}
        self.assertTrue(expr=any((expected_mitre_id <= r.rule_mitre_ids) and (int(r.rule_level) == 15)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 15 alert found with T1021.001, T1563.002 and T1078 MITRE ATT&CK IDs')

    def test_id4688_4778_rdp_hijack_command_execution(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8391154Z", "eventRecordID": "1829536", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B593D\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1490\r\n\tNew Process Name:\tC:\\Windows\\System32\\sc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeFull (2)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0xbc0\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\tsc.exe  start hijackservice\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x13b593d", "newProcessId": "0x1490", "newProcessName": "C:\\Windows\\System32\\sc.exe", "tokenElevationType": "%%1937", "processId": "0xbc0", "commandLine": "sc.exe  start hijackservice", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8467736Z", "eventRecordID": "1829537", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1278\r\n\tNew Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x230\r\n\tCreator Process Name:\tC:\\Windows\\System32\\services.exe\r\n\tProcess Command Line:\tcmd.exe /k tscon 2 /dest:rdp-tcp#5\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1278", "newProcessName": "C:\\Windows\\System32\\cmd.exe", "tokenElevationType": "%%1936", "processId": "0x230", "commandLine": "cmd.exe /k tscon 2 /dest:rdp-tcp#5", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\services.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8530375Z", "eventRecordID": "1829538", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x143c\r\n\tNew Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x1278\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\ttscon  2 /dest:rdp-tcp#5\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x143c", "newProcessName": "C:\\Windows\\System32\\tscon.exe", "tokenElevationType": "%%1936", "processId": "0x1278", "commandLine": "tscon  2 /dest:rdp-tcp#5", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:16.8566410Z", "eventRecordID": "1829539", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x334\r\n\tNew Process Name:\tC:\\Windows\\System32\\conhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x143c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\tscon.exe\r\n\tProcess Command Line:\t\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x334", "newProcessName": "C:\\Windows\\System32\\conhost.exe", "tokenElevationType": "%%1936", "processId": "0x143c", "commandLine": "\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\tscon.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.1608977Z", "eventRecordID": "1829541", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x161c\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x161c", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x13b5e1e", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.4013198Z", "eventRecordID": "1829542", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xbcc\r\n\tNew Process Name:\tC:\\Windows\\System32\\TSTheme.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\TSTheme.exe -Embedding\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xbcc", "newProcessName": "C:\\Windows\\System32\\TSTheme.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\TSTheme.exe -Embedding", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4778", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.5330674Z", "eventRecordID": "1829543", "processID": "576", "threadID": "628", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was reconnected to a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#5\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\nThis event is generated when a user reconnects to an existing Terminal Services session, or when a user switches to an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmarsid", "accountDomain": "OFFSEC", "logonID": "0x6a423", "sessionName": "RDP-Tcp#5", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.8655575Z", "eventRecordID": "1829544", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-20\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E4\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1064\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x33c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\trdpclip\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-20", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e4", "newProcessId": "0x1064", "newProcessName": "C:\\Windows\\System32\\rdpclip.exe", "tokenElevationType": "%%1938", "processId": "0x33c", "commandLine": "rdpclip", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.8803374Z", "eventRecordID": "1829545", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16a0\r\n\tNew Process Name:\tC:\\Windows\\System32\\AtBroker.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xd5c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\winlogon.exe\r\n\tProcess Command Line:\tatbroker.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16a0", "newProcessName": "C:\\Windows\\System32\\AtBroker.exe", "tokenElevationType": "%%1938", "processId": "0xd5c", "commandLine": "atbroker.exe", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\winlogon.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.9362477Z", "eventRecordID": "1829546", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x878\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpinput.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0xeec\r\n\tCreator Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "subjectUserName": "admmarsid", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x6a423", "newProcessId": "0x878", "newProcessName": "C:\\Windows\\System32\\rdpinput.exe", "tokenElevationType": "%%1938", "processId": "0xeec", "commandLine": "\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\rdpclip.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:17.9993967Z", "eventRecordID": "1829547", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xda0\r\n\tNew Process Name:\tC:\\Windows\\System32\\consent.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tconsent.exe 1072 362 000001A5ECFB0F80\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xda0", "newProcessName": "C:\\Windows\\System32\\consent.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "consent.exe 1072 362 000001A5ECFB0F80", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.0786447Z", "eventRecordID": "1829550", "processID": "4", "threadID": "2128", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x16b8\r\n\tNew Process Name:\tC:\\Windows\\System32\\taskhostw.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\ttaskhostw.exe\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x16b8", "newProcessName": "C:\\Windows\\System32\\taskhostw.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "taskhostw.exe", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.1945404Z", "eventRecordID": "1829553", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x17a8\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x17a8", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.3276957Z", "eventRecordID": "1829554", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xeb4\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xeb4", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{133EAC4F-5891-4D04-BADA-D84870380A80}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:18.3438895Z", "eventRecordID": "1829555", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x162c\r\n\tNew Process Name:\tC:\\Windows\\System32\\rdpinput.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0xeec\r\n\tCreator Process Name:\tC:\\Windows\\System32\\rdpclip.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x162c", "newProcessName": "C:\\Windows\\System32\\rdpinput.exe", "tokenElevationType": "%%1938", "processId": "0xeec", "commandLine": "\"C:\\Windows\\System32\\rdpinput.EXE\" /pid:3820 /handle:1456", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\rdpclip.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:26.9427316Z", "eventRecordID": "1829562", "processID": "4", "threadID": "5972", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1578\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{DC4537C3-CA73-4AC7-9E1D-B2CE27C3A7A6}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1578", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{DC4537C3-CA73-4AC7-9E1D-B2CE27C3A7A6}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.4552441Z", "eventRecordID": "1829563", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x864\r\n\tNew Process Name:\tC:\\Windows\\System32\\mmc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-8192\r\n\tCreator Process ID:\t0x9f4\r\n\tCreator Process Name:\tC:\\Windows\\explorer.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "subjectUserName": "admmarsid", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x6a423", "newProcessId": "0x864", "newProcessName": "C:\\Windows\\System32\\mmc.exe", "tokenElevationType": "%%1938", "processId": "0x9f4", "commandLine": "\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\explorer.exe", "mandatoryLabel": "S-1-16-8192"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.5421558Z", "eventRecordID": "1829564", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1620\r\n\tNew Process Name:\tC:\\Windows\\System32\\consent.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x430\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tconsent.exe 1072 426 000001A5F05BA860\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1620", "newProcessName": "C:\\Windows\\System32\\consent.exe", "tokenElevationType": "%%1936", "processId": "0x430", "commandLine": "consent.exe 1072 426 000001A5F05BA860", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.6403302Z", "eventRecordID": "1829569", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x144c\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x144c", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.6766154Z", "eventRecordID": "1829572", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xe84\r\n\tNew Process Name:\tC:\\Windows\\System32\\dllhost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\tC:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xe84", "newProcessName": "C:\\Windows\\System32\\dllhost.exe", "tokenElevationType": "%%1936", "processId": "0x28c", "commandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{E10F6C3A-F1AE-4ADC-AA9D-2FE65525666E}", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-16384"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:29.7069657Z", "eventRecordID": "1829573", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A3F3\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0xcc8\r\n\tNew Process Name:\tC:\\Windows\\System32\\mmc.exe\r\n\tToken Elevation Type:\tTokenElevationTypeFull (2)\r\n\tMandatory Label:\t\tS-1-16-12288\r\n\tCreator Process ID:\t0x9f4\r\n\tCreator Process Name:\tC:\\Windows\\explorer.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0xcc8", "newProcessName": "C:\\Windows\\System32\\mmc.exe", "tokenElevationType": "%%1937", "processId": "0x9f4", "commandLine": "\"C:\\Windows\\system32\\mmc.exe\" \"C:\\Windows\\system32\\eventvwr.msc\" /s", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a3f3", "parentProcessName": "C:\\Windows\\explorer.exe", "mandatoryLabel": "S-1-16-12288"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T20:40:30.6000428Z", "eventRecordID": "1829593", "processID": "4", "threadID": "2884", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1180\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x1628\r\n\tNew Process Name:\tC:\\Windows\\System32\\backgroundTaskHost.exe\r\n\tToken Elevation Type:\tTokenElevationTypeLimited (3)\r\n\tMandatory Label:\t\tS-1-16-4096\r\n\tCreator Process ID:\t0x28c\r\n\tCreator Process Name:\tC:\\Windows\\System32\\svchost.exe\r\n\tProcess Command Line:\t\"C:\\Windows\\system32\\backgroundTaskHost.exe\" -ServerName:CortanaUI.AppXy7vb4pc2dr3kc93kfc509b1d0arkfb2x.mca\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x1628", "newProcessName": "C:\\Windows\\System32\\backgroundTaskHost.exe", "tokenElevationType": "%%1938", "processId": "0x28c", "commandLine": "\"C:\\Windows\\system32\\backgroundTaskHost.exe\" -ServerName:CortanaUI.AppXy7vb4pc2dr3kc93kfc509b1d0arkfb2x.mca", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1180", "targetUserName": "admmarsid", "targetDomainName": "OFFSEC", "targetLogonId": "0x6a423", "parentProcessName": "C:\\Windows\\System32\\svchost.exe", "mandatoryLabel": "S-1-16-4096"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # Ensure there is at least one level 12 alert gets triggered with MITRE labels
        # T1021.001 - Remote Services: Remote Desktop Protocol and T1563.002 - Remote Service Session Hijacking: RDP Hijacking
        expected_mitre_id: set[str] = {'T1021.001', 'T1563.002'}
        self.assertTrue(expr=any((expected_mitre_id <= r.rule_mitre_ids) and (int(r.rule_level) == 12)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 12 alert found with T1021.001 and T1563.002 MITRE ATT&CK IDs')

    def test_id4825_denied_rdp_connection_with_valid_credentials(self) -> None:
        # Logs extracted from EVTX file
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4825", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8010000000000000", "systemTime": "2020-07-12T05:27:05.5797045Z", "eventRecordID": "1231498", "processID": "464", "threadID": "992", "channel": "Security", "computer": "fs02.offsec.lan", "severityValue": "AUDIT_FAILURE", "message": "A user was denied the access to Remote Desktop. By default, users are allowed to connect only if they are members of the Remote Desktop Users group or Administrators group.\r\n\r\nSubject:\r\n\tUser Name:\tsvc6test1\r\n\tDomain:\t\tOFFSEC\r\n\tLogon ID:\t0x3457272\r\n\r\nAdditional Information:\r\n\tClient Address:\t10.23.23.9\r\n\r\n\r\nThis event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop."}, "eventdata": {"accountName": "svc6test1", "accountDomain": "OFFSEC", "logonID": "0x3457272", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4825", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8010000000000000", "systemTime": "2020-07-12T05:28:26.8313792Z", "eventRecordID": "1231525", "processID": "464", "threadID": "284", "channel": "Security", "computer": "fs02.offsec.lan", "severityValue": "AUDIT_FAILURE", "message": "A user was denied the access to Remote Desktop. By default, users are allowed to connect only if they are members of the Remote Desktop Users group or Administrators group.\r\n\r\nSubject:\r\n\tUser Name:\tsvc6test1\r\n\tDomain:\t\tOFFSEC\r\n\tLogon ID:\t0x34696A9\r\n\r\nAdditional Information:\r\n\tClient Address:\t10.23.23.9\r\n\r\n\r\nThis event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop."}, "eventdata": {"accountName": "svc6test1", "accountDomain": "OFFSEC", "logonID": "0x34696a9", "clientAddress": "10.23.23.9"}}}'''
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # Ensure there is at least one level 5 alert gets triggered with T1078 - Valid Accounts and T1021.001 - Remote Services: Remote Desktop Protocol
        expected_mitre_id: set[str] = {'T1021.001', 'T1078'}
        self.assertTrue(expr=any((expected_mitre_id <= r.rule_mitre_ids) and (int(r.rule_level) == 5)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 5 alert found with T1078 and T1021.001 MITRE ATT&CK IDs')

        # Ensure there is an authentication_failed in the groups
        expected_groups: set[str] = {'authentication_failed'}
        self.assertTrue(expr=any((expected_groups <= r.rule_groups) and (int(r.rule_level) == 5)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 5 alert found with group `authentication_failed`')

```

We defined our test cases in Python. In order to write an "at least one" rule, I used a Python `set` and checked for an `intersection` using the AND operation with `&`. The rule level check is more readable. Let's run our code without writing any rules.

{% include gallery id="galleryRed" caption="Unit tests failed, we are in Red state." %}

Unfortunately, the default ruleset of Wazuh does not satisfy the requirements. We must write custom rules. We are definitely in the `RED` state.

Let's define the first rule. We must detect the `tscon` usage for RDP hijacking. Let's cheat a bit here and check what others do. We can only progress by standing on the shoulders of the giants. We have [a Sigma rule in the Sigma HQ repository](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_tscon_rdp_redirect.yml) exactly for this purpose. Let's check the rule here:

```yaml
title: Suspicious RDP Redirect Using TSCON
id: f72aa3e8-49f9-4c7d-bd74-f8ab84ff9bbb
status: test
description: Detects a suspicious RDP session redirect using tscon.exe
references:
    - http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html
    - https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6
    - https://www.hackingarticles.in/rdp-session-hijacking-with-tscon/
author: Florian Roth (Nextron Systems)
date: 2018-03-17
modified: 2023-05-16
tags:
    - attack.lateral-movement
    - attack.t1563.002
    - attack.t1021.001
    - car.2013-07-002
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains: ' /dest:rdp-tcp#'
    condition: selection
falsepositives:
    - Unknown
level: high
```

We can summarize the detection conditions here: In the process creation events, search for `/dest:rdp-tcp#` in the command line field. Also, label the alert with proper MITRE ATT&CK TTPs. This is exactly what we wanted. This covers the first two tests. But this is not sufficient. In the first log sample, we have a more reliable indicator of the attack: the session reconnect events. We must cover that with a higher severity. Then, we can focus on the denied RDP connection. It is nothing but the Security Event ID 4825 - A user was denied the access to Remote Desktop. Let's write the rules now:

```xml
<group name="custom,windows,security,windows_security,">

    <rule id="100000" level="12">
        <if_sid>67027</if_sid>
        <field name="win.eventdata.commandLine">/dest:rdp-tcp#</field>
        <description>Suspicious RDP Redirect Using TSCON</description>
        <info type="link">https://github.com/SigmaHQ/sigma/blob/eeca352f5fd4794f2982ed1a3169b78b1ce38fd2/rules/windows/process_creation/proc_creation_win_tscon_rdp_redirect.yml</info>
        <mitre>
            <id>T1563.002</id>
            <id>T1021.001</id>
        </mitre>
    </rule>

    <rule id="100001" level="15" timeframe="30" frequency="2">
        <if_matched_sid>60108</if_matched_sid>
        <same_field>win.eventdata.sessionName</same_field>
        <different_field>win.eventdata.accountName</different_field>
        <description>Successful RDP hijack detected</description>
        <mitre>
            <id>T1563.002</id>
            <id>T1021.001</id>
            <id>T1078</id>
        </mitre>
    </rule>

    <rule id="100002" level="5">
        <if_sid>60104</if_sid>
        <field name="win.system.eventID">4825</field>
        <description>Denied Access To Remote Desktop</description>
        <info type="link">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4825</info>
        <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
        <mitre>
            <id>T1021.001</id>
            <id>T1078</id>
        </mitre>
    </rule>
</group>
```

Let's run the test once again. We are running the `preflight_tests` and `behavioral_tests`.

{% include gallery id="galleryGreen" caption="Unit tests succeeded, we are in Green state." %}

We reached the `GREEN` state. It is now up to the detection engineers to fine-tune the rules more for the `REFACTOR` phase. It is possible to add more groups and labels or suppress false positive cases. Our behavioral tests are now completed. We can now ensure that Wazuh can detect many of the Lateral Movement events via Remote Desktop. With more coverage, we improved our detection posture.

### Regression testing, again?

We can stop here, but I suggest moving one step further. I have mentioned that regression testing has a purpose: we do not break current functionality in future changes. Since we now have 3 new rules, we can write tests for these specifically to ensure we do not break them in future updates. If you remember the `wazuh-testgen` tool above, it has the ability to create draft tests from rules as well. Usage for test generation from existing rules is simple too:

```bash
usage: generator.py rule [-h] --input_dir INPUT_DIR --output_dir OUTPUT_DIR

options:
  -h, --help            show this help message and exit
  --input_dir, -i INPUT_DIR
                        Directory where input files are located.
  --output_dir, -o OUTPUT_DIR
                        Directory where the Python test files will be saved.
```

When we provide the path to the custom rules file we created above, we can generate the test code below:

```python
import unittest

import internal.logtest as lt


# TODO: Rename the class
class CustomRules(unittest.TestCase):

    def test_rule_100000(self) -> None:
        log = r'''TODO: provide a matching log here'''
        response = lt.send_log(log)

        self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        self.assertEqual(response.rule_id, '100000')
        self.assertEqual(response.rule_level, 12)
        self.assertEqual(response.rule_description, "Suspicious RDP Redirect Using TSCON")
        self.assertIn('custom', response.rule_groups)
        self.assertIn('windows', response.rule_groups)
        self.assertIn('security', response.rule_groups)
        self.assertIn('windows_security', response.rule_groups)

    def test_rule_100001(self) -> None:
        log = r'''TODO: provide a matching log here'''
        response = lt.send_log(log)

        self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        self.assertEqual(response.rule_id, '100001')
        self.assertEqual(response.rule_level, 15)
        self.assertEqual(response.rule_description, "Successful RDP hijack detected")
        self.assertIn('custom', response.rule_groups)
        self.assertIn('windows', response.rule_groups)
        self.assertIn('security', response.rule_groups)
        self.assertIn('windows_security', response.rule_groups)

    def test_rule_100002(self) -> None:
        log = r'''TODO: provide a matching log here'''
        response = lt.send_log(log)

        self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        self.assertEqual(response.rule_id, '100002')
        self.assertEqual(response.rule_level, 5)
        self.assertEqual(response.rule_description, "Denied Access To Remote Desktop")
        self.assertIn('custom', response.rule_groups)
        self.assertIn('windows', response.rule_groups)
        self.assertIn('security', response.rule_groups)
        self.assertIn('windows_security', response.rule_groups)
```

The first and the last ones were easy as they included atomic detections. We can just provide the sample logs, and it would suffice. But the second rule was a temporal detection; two rules in a period of time must be triggered for the correlation. For that, we will use the `send_multiple_logs` function and provide 2 logs instead. This way, the regression test will actually be a slimmed-down version of the behavioral test, so it is up to you if you want to test it or not. Let's fix the test and run it once again.

```python
import unittest

import internal.logtest as lt


class RDPHijackRules(unittest.TestCase):

    def test_rule_990100(self) -> None:
        log = r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4688", "version": "2", "level": "0", "task": "13312", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3522301Z", "eventRecordID": "1829814", "processID": "4", "threadID": "5820", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new process has been created.\r\n\r\nCreator Subject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tFS01$\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x3E7\r\n\r\nTarget Subject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nProcess Information:\r\n\tNew Process ID:\t\t0x378\r\n\tNew Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tToken Elevation Type:\tTokenElevationTypeDefault (1)\r\n\tMandatory Label:\t\tS-1-16-16384\r\n\tCreator Process ID:\t0x13e8\r\n\tCreator Process Name:\tC:\\Windows\\System32\\cmd.exe\r\n\tProcess Command Line:\tcmd  /k tscon 2 /dest:rdp-tcp#8\r\n\r\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\r\n\r\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\r\n\r\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\r\n\r\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator."}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "FS01$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "newProcessId": "0x378", "newProcessName": "C:\\Windows\\System32\\cmd.exe", "tokenElevationType": "%%1936", "processId": "0x13e8", "commandLine": "cmd  /k tscon 2 /dest:rdp-tcp#8", "targetUserSid": "S-1-0-0", "targetLogonId": "0x0", "parentProcessName": "C:\\Windows\\System32\\cmd.exe", "mandatoryLabel": "S-1-16-16384"}}}'''
        response = lt.send_log(log)

        self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        self.assertEqual(response.rule_id, '990100')
        self.assertEqual(response.rule_level, 12)
        self.assertEqual(response.rule_description,
                         "Suspicious RDP Redirect Using TSCON")
        self.assertIn('custom', response.rule_groups)  # type: ignore
        self.assertIn('windows', response.rule_groups)  # type: ignore
        self.assertIn('security', response.rule_groups)  # type: ignore
        self.assertIn('windows_security', response.rule_groups)  # type: ignore

    def test_rule_990101(self) -> None:
        logs: list[str] = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4779", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.3700303Z", "eventRecordID": "1829816", "processID": "576", "threadID": "628", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was disconnected from a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmig\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x13B5E1E\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\n\r\nThis event is generated when a user disconnects from an existing Terminal Services session, or when a user switches away from an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmig", "accountDomain": "OFFSEC", "logonID": "0x13b5e1e", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4778", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-05-14T21:01:05.8317487Z", "eventRecordID": "1829819", "processID": "576", "threadID": "4904", "channel": "Security", "computer": "fs01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A session was reconnected to a Window Station.\r\n\r\nSubject:\r\n\tAccount Name:\t\tadmmarsid\r\n\tAccount Domain:\t\tOFFSEC\r\n\tLogon ID:\t\t0x6A423\r\n\r\nSession:\r\n\tSession Name:\t\tRDP-Tcp#8\r\n\r\nAdditional Information:\r\n\tClient Name:\t\tJUMP01\r\n\tClient Address:\t\t10.23.23.9\r\n\r\nThis event is generated when a user reconnects to an existing Terminal Services session, or when a user switches to an existing desktop using Fast User Switching."}, "eventdata": {"accountName": "admmarsid", "accountDomain": "OFFSEC", "logonID": "0x6a423", "sessionName": "RDP-Tcp#8", "clientName": "JUMP01", "clientAddress": "10.23.23.9"}}}''',
        ]

        responses: list[lt.LogtestResponse] = lt.send_multiple_logs(
            logs, log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        # Ensure there is at least one level 15 alert gets triggered with MITRE labels
        # T1021.001 - Remote Services: Remote Desktop Protocol, T1563.002 - Remote Service Session Hijacking: RDP Hijacking
        # and T1078 - Valid Accounts
        expected_mitre_id: set[str] = {'T1021.001', 'T1563.002', 'T1078'}
        self.assertTrue(expr=any((expected_mitre_id <= r.rule_mitre_ids) and (int(r.rule_level) == 15)  # type: ignore
                                 for r in responses if r.rule_mitre_ids),
                        msg='No level 15 alert found with T1021.001, T1563.002 and T1078 MITRE ATT&CK IDs')

    def test_rule_990105(self) -> None:
        log = r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4825", "version": "0", "level": "0", "task": "12551", "opcode": "0", "keywords": "0x8010000000000000", "systemTime": "2020-07-12T05:27:05.5797045Z", "eventRecordID": "1231498", "processID": "464", "threadID": "992", "channel": "Security", "computer": "fs02.offsec.lan", "severityValue": "AUDIT_FAILURE", "message": "A user was denied the access to Remote Desktop. By default, users are allowed to connect only if they are members of the Remote Desktop Users group or Administrators group.\r\n\r\nSubject:\r\n\tUser Name:\tsvc6test1\r\n\tDomain:\t\tOFFSEC\r\n\tLogon ID:\t0x3457272\r\n\r\nAdditional Information:\r\n\tClient Address:\t10.23.23.9\r\n\r\n\r\nThis event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop."}, "eventdata": {"accountName": "svc6test1", "accountDomain": "OFFSEC", "logonID": "0x3457272", "clientAddress": "10.23.23.9"}}}'''
        response = lt.send_log(log)

        self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)
        self.assertEqual(response.rule_id, '990105')
        self.assertEqual(response.rule_level, 5)
        self.assertEqual(response.rule_description,
                         "Denied Access To Remote Desktop")
        self.assertIn('custom', response.rule_groups)  # type: ignore
        self.assertIn('windows', response.rule_groups)  # type: ignore
        self.assertIn('security', response.rule_groups)  # type: ignore
        self.assertIn('windows_security', response.rule_groups)  # type: ignore
```

You can see the tests are passing. At this point, we can be sure no change in the future will break your detections without ringing some bells or flying some red flags.

{% include gallery id="galleryRegression" caption="Regression tests are passing along with the behavioral tests" %}

## Conclusion

Log replay in Wazuh, when combined with the wazuh-devenv testing framework, elevates detection engineering from guesswork to a repeatable, code-driven discipline. Helpers like wazuhevtx make short work of converting raw EVTX into Wazuh-ready JSONL, while wazuh-testgen turns complex scenarios into ready-to-run behavioral and regression tests. Together, they let you validate high-fidelity detections against real attack telemetry—just one step shy of full attack simulation—without the operational risk or expense. This workflow keeps your rules sharp, your coverage mapped to MITRE ATT&CK, and your changes regression-proof. If you care about maturing your detection pipeline, download these tools, feed them real-world logs, and see how close you can get to adversary emulation before you ever light the match.

---
[^1]:A [Directed Acyclic Graph (DAG)](https://en.wikipedia.org/wiki/Directed_acyclic_graph) is a data structure composed of nodes (in this case, Wazuh rules) connected by one-way edges. "Directed" means that the relationship flows in a single direction, from a parent rule to a more specific child rule. "Acyclic" means there are no loops, ensuring that the analysis process always moves forward and terminates. In Wazuh, this structure allows the analysis engine to efficiently filter events by starting with general rules and navigating down a tree to the most specific match, without having to check every single rule for every log.
[^2]: For this visualization, I used an analysis tool I wrote called simply [rulevis](https://github.com/zbalkan/rulevis). It is in alpha state, but it works!
[^3]: Remember that the rule IDs are unique to the event channel; therefore, the ID numbers by themselves mean nothing. Use the `<Event Channel> <Event Id>` format to be precise.
