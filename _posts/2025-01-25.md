## Enhancing Wazuh Rule Testing with wazuhevtx: A Solution for Windows Event Logs

Wazuh's powerful log analysis and rule engine enables organizations to monitor and respond to a wide range of security events. For Wazuh users, fine-tuning and testing custom rules and decoders is a crucial part of the process. This is where the wazuh-logtest tool shines—providing a sandboxed environment to validate and refine rules against sample logs.

However, when it comes to Windows event logs, wazuh-logtest presents a unique challenge. In this article, we’ll explore the problem and introduce wazuhevtx, a tool designed to bridge the gap and bring seamless rule testing for Windows event logs to the Wazuh ecosystem.

### Rule Testing with wazuh-logtest

The wazuh-logtest tool is an interactive utility that enables users to test rules and decoders in isolation. It allows you to paste sample logs, view their processing lifecycle, and observe which rules match. This three-phase process—pre-decoding, decoding, and filtering—helps users debug decoders, refine rules, and validate expected behaviors.

#### How wazuh-logtest Works

1. **Launch the Tool:** Run wazuh-logtest interactively:

```bash
/var/ossec/bin/wazuh-logtest
```

2. **Paste a Log:** Provide a sample log in the required format. For example:

```plaintext
Oct 15 21:07:00 linux-agent sshd[29205]: Invalid user blimey from 18.18.18.18 port 48928
```

3. **Analyze the Output:** The tool processes the log in three phases

  Phase 1: Pre-Decoding—Extracts metadata such as hostname, program_name, and timestamp.
  Phase 2: Decoding—Matches decoders and extracts specific fields (e.g., srcip, srcuser).
  Phase 3: Filtering—Applies Wazuh rules, displaying matched rule IDs, descriptions, and metadata.

This process makes wazuh-logtest invaluable for testing and debugging custom rules—except when dealing with Windows event logs.

#### The Problem with Windows Event Logs

Unlike typical logs, Windows event logs are structured, binary files that bypass standard decoders. Instead, the Wazuh agent uses a specialized C library to process these logs locally before sending them to the manager[^1]. As a result:

* Windows event logs cannot be tested directly in wazuh-logtest.
* Users are unable to paste raw event data or verify rules against Windows logs in the same way they do with syslog or audit logs.

This limitation leaves a critical gap for Wazuh users who need to validate rules for Windows event channels like Sysmon or Security-Auditing.

### Introducing wazuhevtx

To address this challenge, we developed wazuhevtx, a Python tool that converts Windows event logs (EVTX) into JSON formatted logs that mimic the output of the Wazuh agent. This allows users to test Windows event logs interactively with wazuh-logtest.

#### What Does wazuhevtx Do?

wazuhevtx:

* Reads binary EVTX files from Windows systems.
* Converts events into structured JSON logs, formatted as the Wazuh agent would send them.
* Supports standardized fields like win.system and win.eventdata, ensuring compatibility with Wazuh rules and decoders.
* Enables seamless rule testing in wazuh-logtest.

By bridging the gap between EVTX logs and Wazuh's rule testing capabilities, wazuhevtx empowers users to validate and fine-tune rules for Windows event logs.

#### How to Use wazuhevtx

##### Step 1: Install the Tool

You can use `pip` or clone the repository. If you want to use it both as a library and a CLI tool, install the module using `pipx install https://github.com/zbalkan/wazuhevtx/archive/refs/heads/main.zip`, after you created a virtual environment of your preference.

If you plan to use it only as a CLI tool, I recommend using `pipx` instead.

##### Step 2: Prepare Wazuh server for testing

In order to be able to test with `wazuh-logtest` utility, you need a workaround as we are sending JSON logs, not `event_channel` format.

* Navigate to `/var/ossec/ruleset/rules/0575-win-base_rules.xml` file.
* Update the rule 60000 this way:

```xml
<rule id="60000" level="2">
    <!-- category>ossec</category -->
    <!-- decoded_as>windows_eventchannel</decoded_as -->
    <decoded_as>json</decoded_as>
    <field name="win.system.providerName">\.+</field>
    <options>no_full_log</options>
    <description>Group of windows rules.</description>
</rule>
```

##### Step 3: Convert EVTX Logs to JSON

Run the wazuhevtx tool with your EVTX file as input:

```bash
python wazuhevtx.py sysmon-1.evtx -o sysmon1.json
```

##### Step 4: Test Logs in wazuh-logtest

1. Launch wazuh-logtest:

```bash
/var/ossec/bin/wazuh-logtest
```

2. Copy a single JSON log from the output file (sample.json) and paste it into the wazuh-logtest terminal:

```json
{"win": {"system": {"providerName": "Microsoft-Windows-Sysmon", "providerGuid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}", "eventID": "1", "version": "5", "level": "4", "task": "1", "opcode": "0", "keywords": "0x8000000000000000", "systemTime": "2025-01-20 19:17:01.622587", "eventRecordID": "8513729", "processID": "5984", "threadID": "5172", "channel": "Microsoft-Windows-Sysmon/Operational", "computer": "LABPC", "severityValue": "INFORMATION", "correlation": {"@ActivityID": "", "@RelatedActivityID": ""}, "message": "RuleName: technique_id=T1083,technique_name=File and Directory Discovery\r\nUtcTime: 2025-01-20 19:17:01.619\r\nProcessGuid: {480c9770-a12d-678e-2213-000000007002}\r\nProcessId: 16936\r\nImage: C:\\Program Files\\Mozilla Firefox\\firefox.exe\r\nFileVersion: 134.0.1\r\nDescription: Firefox\r\nProduct: Firefox\r\nCompany: Mozilla Corporation\r\nOriginalFileName: firefox.exe\r\nCommandLine: \"C:\\Program Files\\Mozilla Firefox\\firefox.exe\" -contentproc -parentBuildID 20250113121357 -prefsHandle 1940 -prefsLen 24793 -prefMapHandle 1944 -prefMapSize 265795 -ipcHandle 2008 -initialChannelId {eee169d3-e43f-4043-b52d-1ecfbf1fbb4e} -parentPid 11208 -crashReporter \"\\\\.\\pipe\\gecko-crash-server-pipe.11208\" -win32kLockedDown -appDir \"C:\\Program Files\\Mozilla Firefox\\browser\" - 1 socket\r\nCurrentDirectory: C:\\ProgramData\\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\\updates\\308046B0AF4A39CB\\\r\nUser: LABPC\\Zafer\r\nLogonGuid: {480c9770-7822-678e-0982-040000000000}\r\nLogonId: 0x0000000000048209\r\nTerminalSessionId: 1\r\nIntegrityLevel: Low\r\nHashes: SHA1=75D45A363C5AFD2842054F1AC8C623F31F7B634D,MD5=7965045DCEFD7B6E7AC6E62819F0AA55,SHA256=D8F655E89B08AE12EDDEA0A9E43780BC21B8785BAA4F5A832BC2B53A8C634365,IMPHASH=BB4CE52E8306F88C0B1DA570553704E4\r\nParentProcessGuid: {480c9770-a12c-678e-1e13-000000007002}\r\nParentProcessId: 11208\r\nParentImage: C:\\Program Files\\Mozilla Firefox\\firefox.exe\r\nParentCommandLine: \"C:\\Program Files\\Mozilla Firefox\\firefox.exe\" --MOZ_LOG sync,prependheader,timestamp,append,maxsize:1,Dump:5 --MOZ_LOG_FILE C:\\ProgramData\\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\\updates\\308046B0AF4A39CB\\backgroundupdate.moz_log --backgroundtask backgroundupdate\r\nParentUser: LABPC\\Zafer"}, "eventdata": {"ruleName": "technique_id=T1083,technique_name=File and Directory Discovery", "utcTime": "2025-01-20 19:17:01.619", "processGuid": "{480c9770-a12d-678e-2213-000000007002}", "processId": "16936", "image": "C:\\Program Files\\Mozilla Firefox\\firefox.exe", "fileVersion": "134.0.1", "description": "Firefox", "product": "Firefox", "company": "Mozilla Corporation", "originalFileName": "firefox.exe", "commandLine": "\"C:\\Program Files\\Mozilla Firefox\\firefox.exe\" -contentproc -parentBuildID 20250113121357 -prefsHandle 1940 -prefsLen 24793 -prefMapHandle 1944 -prefMapSize 265795 -ipcHandle 2008 -initialChannelId {eee169d3-e43f-4043-b52d-1ecfbf1fbb4e} -parentPid 11208 -crashReporter \"\\\\.\\pipe\\gecko-crash-server-pipe.11208\" -win32kLockedDown -appDir \"C:\\Program Files\\Mozilla Firefox\\browser\" - 1 socket", "currentDirectory": "C:\\ProgramData\\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\\updates\\308046B0AF4A39CB\\", "user": "LABPC\\Zafer", "logonGuid": "{480c9770-7822-678e-0982-040000000000}", "logonId": "0x0000000000048209", "terminalSessionId": "1", "integrityLevel": "Low", "hashes": "SHA1=75D45A363C5AFD2842054F1AC8C623F31F7B634D,MD5=7965045DCEFD7B6E7AC6E62819F0AA55,SHA256=D8F655E89B08AE12EDDEA0A9E43780BC21B8785BAA4F5A832BC2B53A8C634365,IMPHASH=BB4CE52E8306F88C0B1DA570553704E4", "parentProcessGuid": "{480c9770-a12c-678e-1e13-000000007002}", "parentProcessId": "11208", "parentImage": "C:\\Program Files\\Mozilla Firefox\\firefox.exe", "parentCommandLine": "\"C:\\Program Files\\Mozilla Firefox\\firefox.exe\" --MOZ_LOG sync,prependheader,timestamp,append,maxsize:1,Dump:5 --MOZ_LOG_FILE C:\\ProgramData\\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\\updates\\308046B0AF4A39CB\\backgroundupdate.moz_log --backgroundtask backgroundupdate", "parentUser": "LABPC\\Zafer"}}}

```

3. Observe the output:

```plaintext
**Phase 1: Completed pre-decoding.

**Phase 2: Completed decoding.
        name: 'json'
        win.eventdata.commandLine: '"C:\Program Files\Mozilla Firefox\firefox.exe" -contentproc -parentBuildID 20250113121357 -prefsHandle 1940 -prefsLen 24793 -prefMapHandle 1944 -prefMapSize 265795 -ipcHandle 2008 -initialChannelId {eee169d3-e43f-4043-b52d-1ecfbf1fbb4e} -parentPid 11208 -crashReporter "\\.\pipe\gecko-crash-server-pipe.11208" -win32kLockedDown -appDir "C:\Program Files\Mozilla Firefox\browser" - 1 socket'
        win.eventdata.company: 'Mozilla Corporation'
        win.eventdata.currentDirectory: 'C:\ProgramData\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\updates\308046B0AF4A39CB\'
        win.eventdata.description: 'Firefox'
        win.eventdata.fileVersion: '134.0.1'
        win.eventdata.hashes: 'SHA1=75D45A363C5AFD2842054F1AC8C623F31F7B634D,MD5=7965045DCEFD7B6E7AC6E62819F0AA55,SHA256=D8F655E89B08AE12EDDEA0A9E43780BC21B8785BAA4F5A832BC2B53A8C634365,IMPHASH=BB4CE52E8306F88C0B1DA570553704E4'
        win.eventdata.image: 'C:\Program Files\Mozilla Firefox\firefox.exe'
        win.eventdata.integrityLevel: 'Low'
        win.eventdata.logonGuid: '{480c9770-7822-678e-0982-040000000000}'
        win.eventdata.logonId: '0x0000000000048209'
        win.eventdata.originalFileName: 'firefox.exe'
        win.eventdata.parentCommandLine: '"C:\Program Files\Mozilla Firefox\firefox.exe" --MOZ_LOG sync,prependheader,timestamp,append,maxsize:1,Dump:5 --MOZ_LOG_FILE C:\ProgramData\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\updates\308046B0AF4A39CB\backgroundupdate.moz_log --backgroundtask backgroundupdate'
        win.eventdata.parentImage: 'C:\Program Files\Mozilla Firefox\firefox.exe'
        win.eventdata.parentProcessGuid: '{480c9770-a12c-678e-1e13-000000007002}'
        win.eventdata.parentProcessId: '11208'
        win.eventdata.parentUser: 'LABPC\Zafer'
        win.eventdata.processGuid: '{480c9770-a12d-678e-2213-000000007002}'
        win.eventdata.processId: '16936'
        win.eventdata.product: 'Firefox'
        win.eventdata.ruleName: 'technique_id=T1083,technique_name=File and Directory Discovery'
        win.eventdata.terminalSessionId: '1'
        win.eventdata.user: 'LABPC\Zafer'
        win.eventdata.utcTime: '2025-01-20 19:17:01.619'
        win.system.channel: 'Microsoft-Windows-Sysmon/Operational'
        win.system.computer: 'LABPC'
        win.system.eventID: '1'
        win.system.eventRecordID: '8513729'
        win.system.keywords: '0x8000000000000000'
        win.system.level: '4'
        win.system.message: 'RuleName: technique_id=T1083,technique_name=File and Directory Discovery
UtcTime: 2025-01-20 19:17:01.619
ProcessGuid: {480c9770-a12d-678e-2213-000000007002}
ProcessId: 16936
Image: C:\Program Files\Mozilla Firefox\firefox.exe
FileVersion: 134.0.1
Description: Firefox
Product: Firefox
Company: Mozilla Corporation
OriginalFileName: firefox.exe
CommandLine: "C:\Program Files\Mozilla Firefox\firefox.exe" -contentproc -parentBuildID 20250113121357 -prefsHandle 1940 -prefsLen 24793 -prefMapHandle 1944 -prefMapSize 265795 -ipcHandle 2008 -initialChannelId {eee169d3-e43f-4043-b52d-1ecfbf1fbb4e} -parentPid 11208 -crashReporter "\\.\pipe\gecko-crash-server-pipe.11208" -win32kLockedDown -appDir "C:\Program Files\Mozilla Firefox\browser" - 1 socket
CurrentDirectory: C:\ProgramData\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\updates\308046B0AF4A39CB\
User: LABPC\Zafer
LogonGuid: {480c9770-7822-678e-0982-040000000000}
LogonId: 0x0000000000048209
TerminalSessionId: 1
IntegrityLevel: Low
Hashes: SHA1=75D45A363C5AFD2842054F1AC8C623F31F7B634D,MD5=7965045DCEFD7B6E7AC6E62819F0AA55,SHA256=D8F655E89B08AE12EDDEA0A9E43780BC21B8785BAA4F5A832BC2B53A8C634365,IMPHASH=BB4CE52E8306F88C0B1DA570553704E4
ParentProcessGuid: {480c9770-a12c-678e-1e13-000000007002}
ParentProcessId: 11208
ParentImage: C:\Program Files\Mozilla Firefox\firefox.exe
ParentCommandLine: "C:\Program Files\Mozilla Firefox\firefox.exe" --MOZ_LOG sync,prependheader,timestamp,append,maxsize:1,Dump:5 --MOZ_LOG_FILE C:\ProgramData\Mozilla-1de4eec8-1241-4177-a864-e594e8d1fb38\updates\308046B0AF4A39CB\backgroundupdate.moz_log --backgroundtask backgroundupdate
ParentUser: LABPC\Zafer'
        win.system.opcode: '0'
        win.system.processID: '5984'
        win.system.providerGuid: '{5770385f-c22a-43e0-bf4c-06f5698ffbd9}'
        win.system.providerName: 'Microsoft-Windows-Sysmon'
        win.system.severityValue: 'INFORMATION'
        win.system.systemTime: '2025-01-20 19:17:01.622587'
        win.system.task: '1'
        win.system.threadID: '5172'
        win.system.version: '5'

**Phase 3: Completed filtering (rules).
        id: '61603'
        level: '0'
        description: 'Sysmon - Event 1: Process creation Firefox'
        groups: '['windows', 'sysmon', 'sysmon_event1']'
        firedtimes: '1'
        mail: 'False'
```

Check matched rules, extracted fields, and compliance mappings: you can see, without needing a custom decoder, we extracted all JSON fields, then we managed to get the Sysmon event as a level-0 alert.

### Let's (re)play

The reason is mentioned in the introduction. We are complementing the log testing capability of Wazuh, and Event Logs were an edge case. You can now replay known attacks, and see the detection capabilities of your ruleset.

Let's give it a shot with amazing [EVTX-ATTACK-SAMPLES](https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES) repository by [Samir Bousseaden](https://x.com/sbousseaden).

<img src="/assets/attack-samples.png" width="600" alt="Screenshot of the Github repository">

In the same repo we download the `UACME_59_Sysmon.evtx`, a small sample of events indicating the logs generated when the Windows User Account Control (UAC) bypass tool [UACME](https://github.com/hfiref0x/UACME) for privilege escalation.

<img src="/assets/uacme.png" width="600" alt="Screenshot of the file from Github repository">

My methodoogy includes comparison of the event log displayed on Event Viever against Wazuh logtest results. We are using the default ruleset, so that we can see what Wazuh base ruleset is capable of, and if we have opportunities to write custom detections.

<img src="/assets/uacme-sysmon.png" width="600" alt="Screenshot of the event logs">

We see that there are 7 events in the sample# therefore i will include 7 subsections here.

#### Log 1 (20:43:58.350 UTC): Initial Execution of UACMe (Akagi_64.exe)

* The attacker executed Akagi_64.exe from the UACMe toolset, a known User Account Control (UAC) bypass utility. The process was located in the user's Downloads folder.
* Akagi_64.exe accessed the cmd.exe process in C:\Windows\System32 with access rights (0x1410) that allowed process manipulation.
* The call trace shows interactions with multiple system libraries (ntdll.dll, KERNELBASE.dll, OPENGL32.dll), indicating that the tool exploited standard Windows APIs to bypass UAC and elevate privileges.
* TODO: Add screenshots and Wazuh alert

#### Log 2 (20:43:58.389 UTC): svchost.exe Accesses explorer.exe

* After launching the bypass tool, the system process svchost.exe accessed explorer.exe (Windows shell) with access rights (0x1014C0).
* This interaction likely aimed to manipulate the user interface environment or elevate privileges further within the current session.
* TODO: Add screenshots and Wazuh alert

#### Log 3 (20:43:58.393 UTC): Repeated Access of explorer.exe by svchost.exe

* svchost.exe once again accessed explorer.exe, repeating the interaction from the previous event. This redundancy could indicate efforts to maintain control over the shell environment or validate escalated privileges.
* The granted access rights were the same (0x1014C0), confirming an ongoing manipulation attempt.
* TODO: Add screenshots and Wazuh alert

#### Log 4 (20:43:58.449 UTC): Execution of Windows Task Manager

* The bypass tool Akagi_64.exe launched the Windows Task Manager (Taskmgr.exe) from C:\Windows\System32.
* Task Manager was executed with high integrity level, signifying administrative privileges. This behavior is unusual for attackers as it can alert the user to unauthorized activities. It suggests the attacker may have intended to observe running processes or terminate security tools.
* TODO: Add screenshots and Wazuh alert

#### Log 5 (20:43:58.449 UTC): svchost.exe Accesses Taskmgr.exe

* Immediately after Task Manager was created, svchost.exe accessed the new process (Taskmgr.exe) with maximum access rights (0x1FFFFF).
* This suggests that svchost.exe was being manipulated as part of the attacker’s workflow, maintaining control over the newly spawned administrative process.
* TODO: Add screenshots and Wazuh alert

#### Log 6 (20:43:58.450 UTC): explorer.exe Accesses Taskmgr.exe

* Following svchost.exe, the explorer.exe process accessed Taskmgr.exe. The granted access rights (0x12367B) suggest this was a standard interaction initiated by the desktop shell for process visibility or integration with the Task Manager GUI.
* This interaction likely reflects normal system behavior rather than malicious intent.
* TODO: Add screenshots and Wazuh alert

#### Log 7 (20:43:58.450 UTC): Creation of Command Prompt (cmd.exe)

* Task Manager (Taskmgr.exe) launched a Command Prompt process (cmd.exe) in high integrity mode, signifying that the attacker now had an elevated command-line interface.
* With administrative-level privileges, the attacker could execute further commands, deploy payloads, or modify system configurations for persistence or data exfiltration.
* TODO: Add screenshots and Wazuh alert

### Conclusion

`wazuh-logtest` is a very minimal but usable tool for Wazuh users to test and refine custom rules, but its limitation with Windows event logs has long been a challenge. With `wazuhevtx`, you now have the ability to convert EVTX files into Wazuh-compatible JSON logs, enabling comprehensive rule testing for Windows events.

Get the Tool: [wazuhevtx GitHub Repository](https://github.com/zbalkan/wazuhevtx)

### Postscriptum

This tool requires manual interaction with wazug-logtest tool as the tool resides on Wazuh manager nodes of your -hopefully- test environment. Also, you need a workaround mentioned in Step 2 above to test that you may not want in your production environment. You may need to automate this in the long run. I have another tool that I have been developing for that. It will be another article's topic.

---

[^1] As a side note, this is valid for 4.x versions and earlier. Upcoming version, Wazuh 5.0 may not need it.
